<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML å°„å‡»ç –å—å°æ¸¸æˆ </title>
  <link href='style.css' rel='stylesheet'>
</head>

<body>
  <header align="center"> å°„å‡»ç –å—å°æ¸¸æˆ </header>
  
  <main>
    <audio src="audio/background_music.mp3" preload loop id="music">ä½ çš„æµè§ˆå™¨ç‰ˆæœ¬å¤ªä½ï¼Œä¸æ”¯æŒaudioæ ‡ç­¾</audio>
    <!-- æ¸¸æˆè¿›åº¦æ§åˆ¶æŒ‰é’® -->
    <div align="center">
      <!-- é‡æ–°å¼€å§‹æœ¬å…³ -->
      <button id="repButton">é‡æ–°å¼€å§‹</button>
      <!-- å¼€å§‹æ¸¸æˆ -->
      <button id="staButton">å¼€å§‹æ¸¸æˆ</button>
      <!-- ä¸‹ä¸€å…³ -->
      <button id="nxtButton"><span>ä¸‹ä¸€å…³</span></button>
    </div>

    <div align="right">
      <button id="hintButton">â“</button>

      <button id="soundButton">ğŸ”ˆ</button>
    </div>

    <!-- æ˜¾ç¤ºæ¸¸æˆä¸»ç•Œé¢ -->
    <canvas id='myCanvas' width="480" height="320"></canvas>
    <audio id="effect">ä½ çš„æµè§ˆå™¨ç‰ˆæœ¬å¤ªä½ï¼Œä¸æ”¯æŒaudioæ ‡ç­¾</audio>
    <br>

    <!-- æ˜¾ç¤ºæ¸¸æˆç›¸å…³ä¿¡æ¯ -->
    <canvas id='myCanvas1' width="480" height="160"></canvas>
  </main>

  <script>
    

    let replayBtn = document.querySelector("#repButton");
    let startBtn = document.querySelector("#staButton");
    let nextBtn = document.querySelector("#nxtButton");
    let hintBtn = document.querySelector("#hintButton");
    let soundBtn = document.querySelector("#soundButton");
    // canvasç”¨äºç»˜åˆ¶ä¸»ç•Œé¢ï¼Œcanvas1ç”¨äºç»˜åˆ¶ä¿¡æ¯
    let canvas = document.getElementById("myCanvas");
    let canvas1 = document.getElementById("myCanvas1");
    let ctx = canvas.getContext("2d");
    let ctx1 = canvas1.getContext("2d");
    //å£°éŸ³æ’­æ”¾
    let player = document.querySelector("#effect");
    let music = document.querySelector("#music");
    

    /*çƒçš„å‚æ•°åˆ—è¡¨*/
    let ballRadius = 10; // åŠå¾„
    let x = canvas.width / 2; // xè½´å€¼
    let y = canvas.height - 30; // yè½´å€¼
    let speed = 2; // é€Ÿåº¦
    let dx = speed; // xå˜åŒ–å€¼
    let dy = -speed; // yå˜åŒ–å€¼
    let ballStatus = 0; // çƒçš„çŠ¶æ€ï¼Œç”¨äºæ§åˆ¶çƒçš„å‘å°„æƒ…å†µ

    /*å¹³å°çš„å‚æ•°åˆ—è¡¨*/
    let paddleHeight = 10; //é«˜
    let paddleWidth = 75; // å®½
    let paddleX = (canvas.width - paddleWidth) / 2; // å³ç«¯ç‚¹
    let rightPressed = false; // æ˜¯å¦æŒ‰ä¸‹â†’
    let leftPressed = false; // æ˜¯å¦æŒ‰ä¸‹â†
    let spacePressed = false; // æ˜¯å¦æŒ‰ä¸‹space

    /*ç –å—çš„å‚æ•°åˆ—è¡¨*/
    let brickRowCount = 5; // è¡Œæ•°
    let brickColCount = 3; // åˆ—æ•°
    let brickWidth = 75; // å®½
    let brickHeight = 20; // é«˜
    let brickPadding = 10; // é—´éš”
    let brickOffsetTop = 30; // ä¸Šç•Œ
    let brickOffsetLeft = 30; // å·¦ç•Œ
    let brickTotalNum = 1; // ä¸ªæ•°

    /*å…¶ä»–*/
    let score = 0; // æ˜¾ç¤ºå½“å‰å…³å¡çš„åˆ†æ•°
    let lives = 3; // æ˜¾ç¤ºæœ¬æ¬¡æ¸¸æˆçš„ç”Ÿå‘½æ•°
    let startTime = null; // å¼€å§‹æ—¶é—´ï¼ŒæŒ‰ä¸‹ç©ºæ ¼å¼€å§‹è®¡æ—¶
    let time = null; // æœ¬æ¬¡æ¸¸æˆçš„æ—¶é—´
    let level = 1; // æ˜¾ç¤ºæ­¤æ¬¡æ¸¸æˆçš„ç­‰çº§
    let levelUpNeedExp = 10; // å‡çº§åˆ°ä¸‹ä¸€ä¸ªç­‰çº§æ‰€éœ€è¦çš„åˆ†æ•°
    let expNum = 0; // å½“å‰ç»éªŒå€¼
    let stop = null; // ç”¨äºæ§åˆ¶åŠ¨ç”»åœæ­¢çš„id

    let bricks = [];

    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);
    document.addEventListener("mousemove", mouseMoveHandler, false);
    replayBtn.addEventListener("click", replayGame);
    startBtn.addEventListener("click", startGame);
    nextBtn.addEventListener("click", nextGame);
    hintBtn.addEventListener("click", hint);
    soundBtn.addEventListener("click", playSound);
    player.addEventListener('canplaythrough', () => {
      player.play();
    })

    function keyDownHandler(e) {
      if (e.code == "ArrowRight") {
        rightPressed = true;
      } else if (e.code == "ArrowLeft") {
        leftPressed = true;
      } else if (e.code == "Space") {
        spacePressed = true;
        ballStatus = 1;
        startTime = new Date().getTime();
      }
    }

    function keyUpHandler(e) {
      if (e.code == "ArrowRight") {
        rightPressed = false;
      } else if (e.code == "ArrowLeft") {
        leftPressed = false;
      } else if (e.code == "Space") {
        spacePressed = false;
      }
    }

    function mouseMoveHandler(e) {
      let relativeX = e.clientX - canvas.offsetLeft;
      if (relativeX > 0 && relativeX < canvas.width) {
        paddleX = relativeX - paddleWidth / 2;
        if (!ballStatus) x = relativeX
      }
    }

    /*
     * ç –å—ç¢°æ’æ£€æµ‹ï¼š
     * è·å–æ¯ä¸ªç –å—çš„çŠ¶æ€ï¼Œå¦‚æœå½“å‰ç –å—æœªæ¶ˆé™¤ï¼Œå¹¶ä¸”å°çƒå·²ç»åœ¨ç –å—çš„èŒƒå›´å†…åˆ™åˆ¤å®šä¸ºç¢°æ’æˆåŠŸï¼›
     * ç¢°æ’åç –å—æ¶ˆé™¤ï¼Œdyå˜ä¸ºç›¸åæ•°ï¼Œåˆ†æ•°å¢åŠ ï¼Œç›¸åº”ç­‰çº§ä¹Ÿä¼šå˜åŒ–ï¼›
     * å¦‚æœå·²ç»ç¢°å®Œæ‰€æœ‰ç –å—ï¼Œåˆ™æç¤ºæœ¬å…³ç»“æŸï¼›
    */
    function collisionDetection() {
      for (let col = 0; col < brickColCount; col++) {
        for (let row = 0; row < brickRowCount; row++) {
          let b = bricks[col][row];
          if (b.status == 1) {
            if (x > b.x && x < b.x + brickWidth && y > b.y && y < b.y + brickHeight) {
              player.src = "audio/brick_ball.wav";
              player.load();
              dy = -dy;
              b.status = 0;
              score++;
              if (expNum < levelUpNeedExp) expNum++;            // å¦‚æœå·²ç»åˆ°è¾¾æœ€å¤§ç­‰çº§ä¸”ç»éªŒå·²æ»¡åˆ™ä¸å†å¢åŠ 
              if (expNum == levelUpNeedExp && level < 10) {     // å¦‚æœå½“å‰ç»éªŒå€¼æ»¡è¶³å‡çº§æ¡ä»¶
                player.src = "audio/levelup.wav";
                player.load();
                level++;                                        // ç­‰çº§æå‡ä¸€çº§
                levelUpNeedExp += 10;                           // å‡çº§è¦æ±‚æå‡
                expNum = 0;                                     // å½“å‰ç»éªŒæ¡æ¸…ç©º
                speed += 0.5;
                dx = speed;
                dy = -speed;
              }
            }
          }
        }
      }
    }

    /*ç»˜åˆ¶å¼¹ç */
    function drawBall() {
      ctx.beginPath();
      ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
      ctx.fillStyle = "#097EFF";
      ctx.fill();
      ctx.closePath();
    }

    /*ç»˜åˆ¶å¹³å°*/
    function drawPaddle() {
      ctx.beginPath();
      ctx.rect(paddleX, canvas.height - paddleHeight, paddleWidth, paddleHeight);
      ctx.fillStyle = "#097EFF";
      ctx.fill();
      ctx.closePath();
    }

    /*
     * éšæœºç”ŸæˆæŒ‡å®šæ•°é‡çš„ç –å—
    */
    function shuffle(arr) {
      let len = arr.length;
      for (let i = 0; i < len - 1; i++) {
        let index = Math.floor(Math.random() * (len - i));
        let temp = arr[index];
        arr[index] = arr[len - i - 1];
        arr[len - i - 1] = temp;
      }
      return arr;
    }

    /*åˆå§‹åŒ–ç –å—*/
    function initBricks() {
      for (let col = 0; col < brickColCount; col++) {
        bricks[col] = [];
        for (let row = 0; row < brickRowCount; row++) {
          bricks[col][row] = { x: 0, y: 0, status: 0 };
        }
      }
      let arr = shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]).slice(0, brickTotalNum); // æˆªå–å‰brickTotalNumä¸ª
      let index = 1;
      for (let col = 0; col < brickColCount; col++) {
        for (let row = 0; row < brickRowCount; row++, index++) {
          if (arr.includes(index)) {
            bricks[col][row].status = 1;
          }
        }
      }
    }

    /*ç»˜åˆ¶ç –å—*/
    function drawBricks() {
      for (let col = 0; col < brickColCount; col++) {
        for (let row = 0; row < brickRowCount; row++) {
          if (bricks[col][row].status == 1) {
            let brickX = (row * (brickWidth + brickPadding)) + brickOffsetLeft;
            let brickY = (col * (brickHeight + brickPadding)) + brickOffsetTop;
            bricks[col][row].x = brickX;
            bricks[col][row].y = brickY;
            ctx.beginPath();
            ctx.rect(brickX, brickY, brickWidth, brickHeight);
            ctx.fillStyle = "#097EFF";
            ctx.fill();
            ctx.closePath();
          }
        }
      }
    }

    /*ç»˜åˆ¶è®°åˆ†æ¿*/
    function drawScore() {
      ctx.font = "16px Menlo";
      ctx.fillStyle = "#002FA7";
      ctx.fillText("Score: " + score, 8, 20);
    }

    /*ç»˜åˆ¶ç”Ÿå‘½é¢æ¿*/
    function drawLives() {
      ctx1.font = "16px Menlo";
      ctx1.fillStyle = "#FF0000";
      ctx1.fillText("Lives: ", 8, 20);
      for (let i = 0; i < lives; i++) {
        ctx1.fillText("â¤ï¸", 50 + 20*i, 20);
      }
    }

    /*ç»˜åˆ¶ç­‰çº§é¢æ¿*/
    function drawLevel() {
      ctx1.font = "16px Menlo";
      ctx1.fillStyle = "#FFC900";
      ctx1.fillText("Level: " + level, 8, 40);
      ctx1.fillText("Exp ", 8, 60);
      ctx1.beginPath();
      ctx1.rect(40, 50, expNum * ((440 - 40) / levelUpNeedExp), 10);
      ctx1.fillStyle = "#FFC900";
      ctx1.fill();
      ctx1.closePath();
      // ctx1.fillText("dx: " + dx, 8, 80);
      // ctx1.fillText("dy: " + dy, 8, 100);
    }

    /*ç»˜åˆ¶è§„åˆ™é¢æ¿*/
    function drawRule() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
      ctx.font = "16px Menlo";
      ctx.fillStyle = "#000000";
      ctx.fillText("ã€æ§åˆ¶æ–¹å¼ã€‘", 8, 20);
      ctx.fillText(" â†ï¼šå·¦ç§»  â†’ï¼šå³ç§» / é¼ æ ‡å·¦å³ç§»åŠ¨ï¼šå·¦å³ç§»åŠ¨", 8, 40);
      ctx.fillText("spaceï¼šå‘å°„å¼¹ç ", 8, 60);
      ctx.fillText("ã€æ¸¸æˆè§„åˆ™ã€‘", 8, 80);
      ctx.fillText("æ§åˆ¶å¹³å°ç§»åŠ¨ï¼Œåˆ©ç”¨å¼¹ç åå¼¹æ¶ˆé™¤æ‰€æœ‰ç –å—å³å¯é€šè¿‡å…³å¡", 8, 100);
      ctx.fillText("æ¯ä¸ªå…³å¡ä¼šéšæœºç”Ÿæˆä¸åŒæ•°é‡çš„ç –å—ï¼Œè¶Šå¾€åçš„å…³å¡ç –å—æ•°é‡è¶Šå¤š", 8, 120);
      ctx.fillText("å…³å¡æ•°é‡ä¸º8", 8, 140);
      ctx.fillText("ã€ç­‰çº§åˆ¶åº¦ã€‘", 8, 160);
      ctx.fillText("æ¯æ¬¡è·å¾—åˆ†æ•°éƒ½ä¼šç´¯åŠ ç»éªŒå€¼ï¼Œç»éªŒå€¼æ»¡åç­‰çº§ä¼šæå‡", 8, 180);
      ctx.fillText("éšç€ç­‰çº§çš„æå‡ï¼Œå°çƒçš„é€Ÿåº¦ä¼šå¢åŠ ", 8, 200);
      ctx.fillText("ç­‰çº§æœ€å¤§ä¸º10çº§", 8, 220);
      ctx.fillText("ã€ç”Ÿå‘½åˆ¶åº¦ã€‘", 8, 240);
      ctx.fillText("ä½ æœ‰3æ¡ç”Ÿå‘½ï¼Œæ¯æ¬¡å¤±è´¥ä¼šæ¶ˆè€—1æ¡ç”Ÿå‘½", 8, 260);
      ctx.fillText("å½“ç”Ÿå‘½å€¼è€—å°½æ—¶ï¼Œä½ çš„ç­‰çº§ä¼šä¸‹é™ä¸€çº§ï¼ˆæœ€ä½ä¸º1ï¼‰", 8, 280);
      ctx.fillText("ä¸”å½“å‰ç»éªŒå€¼ä¼šæ¸…ç©º, ç„¶åæ¢å¤æ‰€æœ‰ç”Ÿå‘½å€¼", 8, 300);
    }

    /*ç»˜åˆ¶æ—¶é—´é¢æ¿*/
    function drawTime() {
      time = new Date().getTime() - startTime;
      ctx.font = "16px Menlo";
      ctx.fillStyle = "#000000";
      ctx.fillText("Time: " + (ballStatus == 0 ? 0 : Math.floor(time / 1000)) + " s", 200, 20);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
      ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
      drawBricks();
      drawBall();
      drawPaddle();
      drawScore();
      drawTime();
      drawLevel();
      drawLives();
      collisionDetection();

      // å¦‚æœç¢°åˆ°å·¦å³è¾¹ç•Œï¼Œæ”¹å˜è¿åŠ¨æ–¹å‘
      if (x + dx > canvas.width - ballRadius || x + dx < ballRadius) {
        player.src = "audio/offset_ball.wav";
        player.load();
        dx = -dx;
      }

      if (y + dy < ballRadius) { // ç¢°åˆ°ä¸Šè¾¹ç•Œï¼Œæ”¹å˜è¿åŠ¨æ–¹å‘
        player.src = "audio/offset_ball.wav";
        player.load();
        dy = -dy;
      } else if (y + dy > canvas.height - ballRadius) { // å¦‚æœç¢°åˆ°ä¸‹ç•Œ  
        if (x > paddleX && x < paddleX + paddleWidth) { // ä¸”åœ¨å¹³æ¿èŒƒå›´å†…ï¼Œæ”¹å˜è¿åŠ¨æ–¹å‘
          player.src = "audio/paddle_ball.wav";
          player.load();
          dy = -dy;
        } else {
          lives--;
          if (lives > 0) {
            ballStatus = 0;
            x = canvas.width / 2;
            y = canvas.height - 30;
            dx = speed;
            dy = -speed;
            paddleX = (canvas.width - paddleWidth) / 2;
            score = 0;
            initBricks();
          }
        }
      }

      if (rightPressed && paddleX < canvas.width - paddleWidth) {
        paddleX += 7;
        if (!ballStatus) {
          x += 7;
        }
      }

      if (leftPressed && paddleX > 0) {
        paddleX -= 7;
        if (!ballStatus) {
          x -= 7;
        }
      }

      if (!ballStatus && spacePressed) {
        x += dx;
        y += dy;
      }

      if (ballStatus) {
        x += dx;
        y += dy;
      }

      stop = requestAnimationFrame(draw);

      if (score == brickTotalNum) {
        //è¿›å…¥ä¸‹ä¸€å…³
        replayBtn.disabled = false;
        startBtn.disabled = false;
        nextBtn.disabled = false;
        player.src = "audio/finished.wav";
        player.load();
        cancelAnimationFrame(stop);
        drawFinish();
        drawLevel();
        drawLives();
      }

      if (lives < 0) {
        replayBtn.disabled = false;
        startBtn.disabled = false;
        player.src = "audio/gameover.wav";
        player.load();
        cancelAnimationFrame(stop);
        drawOver();
        drawLevel();
        drawLives();
      }

    }

    drawLevel();
    drawLives();
    nextBtn.disabled = true;
    
    /*é€šå…³åæç¤ºä¿¡æ¯*/
    function drawFinish() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
      ctx.font = "16px Menlo";
      ctx.fillStyle = "#000000";
      ctx.fillText("æ­å–œä½ å®Œæˆæœ¬å…³ï¼ï¼ï¼", 8, 20);
      ctx.fillText("ç‚¹å‡» é‡æ–°å¼€å§‹ å¯é‡æ–°æ¸¸ç©æœ¬å…³!", 8, 40);
      ctx.fillText("ç‚¹å‡» ä¸‹ä¸€å…³ å¯æ¸¸ç©ä¸‹ä¸€å…³ï¼", 8, 60);
    }

    /*æ­»äº¡åæç¤ºä¿¡æ¯*/
    function drawOver() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // æ¸…ç©ºç”»å¸ƒ
      ctx.font = "16px Menlo";
      ctx.fillStyle = "#000000";
      ctx.fillText("å¾ˆé—æ†¾ä½ å·²ç»æ²¡æœ‰ç”Ÿå‘½å€¼äº†ï¼", 8, 20);
      ctx.fillText("ç‚¹å‡» é‡æ–°å¼€å§‹ å¯é‡æ–°æ¸¸ç©æœ¬å…³!", 8, 40);
      ctx.fillText("ä½†æ˜¯ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ çš„å½“å‰ç»éªŒå€¼ä¼šæ¸…ç©ºï¼Œä¸”ç­‰çº§ä¸‹é™ä¸€çº§ï¼", 8, 60);
    }

    function replayGame() {
      replayBtn.disabled = true;
      startBtn.disabled = true;
      nextBtn.disabled = true;
      if (lives <= 0) {
        lives = 3;
        expNum = 0;
        if (level > 1) {
          level--;
          speed -= 0.5;
          dx = speed;
          dy = - speed;
        }
      }
      ballStatus = 0;
      score = 0;
      x = canvas.width / 2;
      y = canvas.height - 30;
      paddleX = (canvas.width - paddleWidth) / 2;
      initBricks();
      draw();
    }

    function startGame() {
      replayBtn.disabled = true;
      startBtn.disabled = true;
      nextBtn.disabled = true;
      ballStatus = 0;
      score = 0;
      x = canvas.width / 2;
      y = canvas.height - 30;
      paddleX = (canvas.width - paddleWidth) / 2;
      initBricks();
      draw();
    }

    function nextGame() {
      replayBtn.disabled = true;
      startBtn.disabled = true;
      nextBtn.disabled = true;
      ballStatus = 0;
      score = 0;
      x = canvas.width / 2;
      y = canvas.height - 30;
      paddleX = (canvas.width - paddleWidth) / 2;
      if (brickTotalNum < 15) brickTotalNum += 2;
      initBricks();
      draw();
    }

    function hint() {
      if (startBtn.disabled == true) cancelAnimationFrame(stop);
      drawRule();
      startBtn.disabled = false;
    }

    function playSound() {
      console.log(music.pause);
      if (soundBtn.innerHTML == "ğŸ”Š") {
        soundBtn.innerHTML = "ğŸ”ˆ";
        //music.pause = true;
        music.pause();
      } else if (soundBtn.innerHTML == "ğŸ”ˆ") {
        soundBtn.innerHTML = "ğŸ”Š";
        //music.pause = false;
        music.play();
      }
    }

  </script>
</body>

</html>